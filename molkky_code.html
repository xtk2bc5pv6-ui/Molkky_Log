<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M√∂lkky Battle Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1f2937; color: white; font-family: sans-serif; touch-action: manipulation; }
        
        .view-section { display: none; height: 100vh; flex-direction: column; }
        .active-view { display: flex; }

        /* „Çπ„Ç≠„ÉÉ„Éà„É´„Éú„Çø„É≥ */
        .pin-btn {
            width: 58px; height: 58px;
            border-radius: 50%;
            background-color: #d4a373; color: #3e2723;
            font-size: 1.4rem; font-weight: bold;
            display: flex; align-items: center; justify-center: center;
            box-shadow: 0 4px 0 #8d6e63;
            transition: all 0.1s;
        }
        .pin-btn:active { transform: translateY(4px); box-shadow: none; }

        /* ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂº∑Ë™ø */
        .current-turn { border: 2px solid #fbbf24; background-color: #374151; }
        
        /* „Çπ„ÉÜ„Éº„Çø„ÇπÂà•„ÅÆË°å„Çπ„Çø„Ç§„É´ */
        .row-playing { }
        .row-cleared { background-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; } /* Á∑ë„Å£„ÅΩ„Åè */
        .row-eliminated { background-color: rgba(0, 0, 0, 0.5); color: #6b7280; opacity: 0.6; } /* Êöó„Åè */
    </style>
</head>
<body class="max-w-md mx-auto bg-gray-900 shadow-2xl overflow-hidden">

    <div id="view-title" class="view-section active-view justify-center items-center p-6 text-center space-y-8">
        <div>
            <h1 class="text-4xl font-bold text-yellow-500 mb-2">M√∂lkky<br>Battle</h1>
            <p class="text-gray-400 text-sm">ÂÆåÂÖ®Ê±∫ÁùÄ„É´„Éº„É´</p>
        </div>
        <button onclick="goToSetup()" class="w-full py-4 bg-yellow-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-yellow-500 transition">
            Êñ∞„Åó„ÅÑË©¶Âêà
        </button>
    </div>

    <div id="view-setup" class="view-section p-6">
        <h2 class="text-xl font-bold text-center mb-6 border-b border-gray-700 pb-2">„Éó„É¨„Ç§„É§„ÉºÈÅ∏Êäû</h2>
        
        <div class="flex-grow overflow-y-auto space-y-3 mb-4" id="player-input-list">
            <input type="text" value="Player 1" class="player-name-input w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
            <input type="text" value="Player 2" class="player-name-input w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
            <input type="text" value="Player 3" class="player-name-input w-full p-3 bg-gray-800 rounded border border-gray-600 text-white">
        </div>

        <button onclick="addPlayerInput()" class="w-full py-2 mb-4 bg-gray-700 text-gray-300 rounded-lg text-sm border-dashed border-2 border-gray-600">+ „É°„É≥„Éê„Éº„ÇíËøΩÂä†</button>

        <button onclick="startGame()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg">
            Ë©¶ÂêàÈñãÂßã
        </button>
        <button onclick="showView('view-title')" class="mt-4 text-gray-500 text-sm text-center w-full">Êàª„Çã</button>
    </div>

    <div id="view-game" class="view-section">
        <div class="bg-gray-800 p-2 flex-grow overflow-y-auto">
            <table class="w-full text-left">
                <thead class="text-xs text-gray-500 border-b border-gray-700">
                    <tr>
                        <th class="pb-1 pl-2">NAME</th>
                        <th class="pb-1 text-center">MISS</th>
                        <th class="pb-1 text-right pr-4">SCORE</th>
                    </tr>
                </thead>
                <tbody id="scoreboard-body" class="text-sm"></tbody>
            </table>
        </div>

        <div class="bg-gray-900 p-4 pb-8 rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-10">
            <div class="flex justify-between items-center mb-4 px-2">
                <div>
                    <span class="text-xs text-green-400 block">THROWING NEXT</span>
                    <span id="current-player-name" class="text-xl font-bold text-white">Player Name</span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-400 block">TARGET</span>
                    <span class="text-2xl font-mono text-yellow-400">50</span>
                </div>
            </div>

            <div class="flex flex-col items-center gap-3 mb-4">
                <div class="flex gap-4"> 
                    <button class="pin-btn" onclick="inputScore(7)">7</button>
                    <button class="pin-btn" onclick="inputScore(9)">9</button>
                    <button class="pin-btn" onclick="inputScore(8)">8</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="pin-btn" onclick="inputScore(5)">5</button>
                    <button class="pin-btn" onclick="inputScore(11)">11</button>
                    <button class="pin-btn" onclick="inputScore(12)">12</button>
                    <button class="pin-btn" onclick="inputScore(6)">6</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="pin-btn" onclick="inputScore(3)">3</button>
                    <button class="pin-btn" onclick="inputScore(10)">10</button>
                    <button class="pin-btn" onclick="inputScore(4)">4</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="pin-btn" onclick="inputScore(1)">1</button>
                    <button class="pin-btn" onclick="inputScore(2)">2</button>
                </div>
            </div>

            <button onclick="inputScore(0)" class="w-full py-3 bg-red-900/80 text-red-200 font-bold rounded-xl border border-red-800 active:bg-red-800">
                MISS (0ÁÇπ)
            </button>
        </div>
    </div>

    <div id="view-result" class="view-section justify-center items-center p-6 text-center">
        <h2 class="text-3xl text-yellow-400 font-bold mb-6">GAME SET!</h2>
        
        <div class="w-full bg-gray-800 rounded-xl p-4 mb-8 text-left space-y-2" id="result-list">
            </div>
        
        <button onclick="showView('view-title')" class="w-full py-4 bg-gray-700 text-white rounded-xl font-bold">
            „Çø„Ç§„Éà„É´„Å∏Êàª„Çã
        </button>
    </div>

    <script>
        // „Éó„É¨„Ç§„É§„Éº„ÅÆÁä∂ÊÖãÂÆöÊï∞
        const STATUS = {
            PLAYING: 'playing',       // „Éó„É¨„Ç§‰∏≠
            CLEARED: 'cleared',       // 50ÁÇπ„ÅÇ„Åå„Çä
            ELIMINATED: 'eliminated'  // Â§±Ê†º
        };

        let players = [];
        let currentIndex = 0;
        let clearOrder = []; // ‰∏ä„Åå„Å£„ÅüÈ†Ü„Å´ÂêçÂâç„ÇíÂÖ•„Çå„Çã
        let eliminatedStack = []; // Â§±Ê†º„Åó„ÅüÈ†Ü„Å´ÂêçÂâç„ÇíÂÖ•„Çå„ÇãÔºàÊúÄÂæåÂ∞æ„Åå‰∏ÄÁï™ÊúÄËøë„ÅÆÂ§±Ê†ºÔºâ

        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
        }

        function goToSetup() { showView('view-setup'); }

        function addPlayerInput() {
            const list = document.getElementById('player-input-list');
            const count = list.children.length + 1;
            const input = document.createElement('input');
            input.type = "text";
            input.value = "Player " + count;
            input.className = "player-name-input w-full p-3 bg-gray-800 rounded border border-gray-600 text-white mt-2";
            list.appendChild(input);
        }

        function startGame() {
            const inputs = document.querySelectorAll('.player-name-input');
            players = [];
            clearOrder = [];
            eliminatedStack = [];

            inputs.forEach(input => {
                if(input.value.trim() !== ""){
                    players.push({ 
                        name: input.value, 
                        score: 0, 
                        miss: 0, 
                        status: STATUS.PLAYING 
                    });
                }
            });

            if(players.length < 1) { alert("„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åõ„Çì"); return; }

            currentIndex = 0;
            updateScoreboard();
            showView('view-game');
        }

        function inputScore(points) {
            const player = players[currentIndex];

            // --- 1. „Çπ„Ç≥„Ç¢Ë®àÁÆóÂá¶ÁêÜ ---
            if(points === 0) {
                player.miss += 1;
                if(player.miss >= 3) {
                    // Â§±Ê†ºÂá¶ÁêÜ
                    player.status = STATUS.ELIMINATED;
                    eliminatedStack.push(player); // Â§±Ê†º„É™„Çπ„Éà„Å´ËøΩÂä†
                    alert(`üíÄ ${player.name} „Åï„Çì„ÄÅ3ÂõûÈÄ£Á∂ö„Éü„Çπ„ÅßÂ§±Ê†º...`);
                }
            } else {
                player.miss = 0; // „Éü„Çπ„É™„Çª„ÉÉ„Éà
                let nextScore = player.score + points;
                
                if(nextScore === 50) {
                    // „ÇØ„É™„Ç¢Âá¶ÁêÜ
                    player.score = 50;
                    player.status = STATUS.CLEARED;
                    clearOrder.push(player); // „ÇØ„É™„Ç¢„É™„Çπ„Éà„Å´ËøΩÂä†
                    alert(`üéâ ${player.name} „Åï„Çì„ÄÅ50ÁÇπ„ÇØ„É™„Ç¢ÔºÅ`);
                } else if(nextScore > 50) {
                    alert("„Ç™„Éº„Éê„ÉºÔºÅ25ÁÇπ„Å´Êàª„Çä„Åæ„Åô„ÄÇ");
                    player.score = 25;
                } else {
                    player.score = nextScore;
                }
            }

            updateScoreboard();

            // --- 2. „Ç≤„Éº„É†ÁµÇ‰∫ÜÂà§ÂÆö ---
            // „Åæ„Å†„Éó„É¨„Ç§‰∏≠„ÅÆ‰∫∫Êï∞„ÇíÊï∞„Åà„Çã
            const activePlayers = players.filter(p => p.status === STATUS.PLAYING);
            
            // ÊÆã„Çä„Åå1‰∫∫‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÁµÇ‰∫Ü (‰æã: 3‰∫∫‰∏≠2‰∫∫Â§±Ê†º„ÄÅ„Åæ„Åü„ÅØ3‰∫∫‰∏≠2‰∫∫„ÇØ„É™„Ç¢)
            if (activePlayers.length <= 1) {
                // „ÇÇ„Åó„ÄåÂÖ®Âì°„ÇØ„É™„Ç¢„Äçor„Äå1‰∫∫ÊÆã„Åó„Å¶‰ªñÂÖ®Âì°Â§±Ê†º/„ÇØ„É™„Ç¢„Äç„Å™„ÇâÁµÇ‰∫Ü
                finishGame();
                return; 
            }

            // --- 3. Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å∏ÔºàÂ§±Ê†º„Éª„ÇØ„É™„Ç¢Ê∏à„Åø„ÅÆ‰∫∫„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ ---
            let loopCount = 0;
            do {
                currentIndex = (currentIndex + 1) % players.length;
                loopCount++;
                // ÂÖ®Âì°„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÇÇË™∞„ÇÇ„ÅÑ„Å™„Åë„Çå„Å∞„É´„Éº„ÉóËÑ±Âá∫ÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
                if(loopCount > players.length) break;
            } while (players[currentIndex].status !== STATUS.PLAYING);

            updateScoreboard();
            // ÂêçÂâçË°®Á§∫Êõ¥Êñ∞
            document.getElementById('current-player-name').innerText = players[currentIndex].name;
        }

        function updateScoreboard() {
            const tbody = document.getElementById('scoreboard-body');
            tbody.innerHTML = "";

            players.forEach((p, index) => {
                const tr = document.createElement('tr');
                
                // Ë°å„ÅÆ„Çπ„Çø„Ç§„É´Âà§ÂÆö
                let rowClass = "row-playing";
                let statusIcon = "";
                
                if (p.status === STATUS.ELIMINATED) {
                    rowClass = "row-eliminated";
                    statusIcon = "üíÄ";
                } else if (p.status === STATUS.CLEARED) {
                    rowClass = "row-cleared";
                    statusIcon = "üëë";
                } else if (index === currentIndex) {
                    rowClass = "current-turn"; // „Éó„É¨„Ç§‰∏≠„Åã„Å§ÁèæÂú®„ÅÆÁï™
                } else {
                    rowClass = "border-b border-gray-700"; // ÂæÖÊ©ü‰∏≠
                }

                tr.className = rowClass;

                // „Éü„ÇπË°®Á§∫
                let missHtml = "";
                for(let i=0; i<3; i++) missHtml += (i < p.miss) ? "‚ùå" : "<span class='text-gray-600'>‚óè</span>";

                tr.innerHTML = `
                    <td class="py-3 pl-2 font-bold flex items-center">
                        ${statusIcon} ${p.name}
                        ${index === currentIndex && p.status === STATUS.PLAYING ? '<span class="text-xs ml-1 animate-pulse">‚óÄ</span>' : ''}
                    </td>
                    <td class="text-center text-xs tracking-tighter">${missHtml}</td>
                    <td class="text-right pr-4 font-mono text-xl font-bold">${p.status === STATUS.ELIMINATED ? '-' : p.score}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function finishGame() {
            // È†Ü‰Ωç„Çí‰ΩúÊàê„Åô„Çã
            // 1. „ÇØ„É™„Ç¢„Åó„Åü‰∫∫ÔºàÈ†ÜÂ∫èÈÄö„ÇäÔºâ
            // 2. „Åæ„Å†„Éó„É¨„Ç§‰∏≠„ÅÆ‰∫∫ÔºàÁîü„ÅçÊÆã„Çä - ‰∫ãÂÆü‰∏ä„ÅÆ„ÇØ„É™„Ç¢Êâ±„ÅÑ„Å®„Åó„Å¶„ÇØ„É™„Ç¢ÁµÑ„ÅÆÊ¨°„Å∏Ôºâ
            // 3. Â§±Ê†º„Åó„Åü‰∫∫ÔºàÂ§±Ê†º„ÅåÈÅÖ„Åã„Å£„Åü‰∫∫„Åå‰∏ä‰Ωç -> Stack„ÅÆÂæå„Çç„Åã„ÇâÂèñ„ÇäÂá∫„ÅôÔºâ

            const survivors = players.filter(p => p.status === STATUS.PLAYING);
            
            // ÊúÄÁµÇ„É©„É≥„Ç≠„É≥„Ç∞‰ΩúÊàê
            let finalRanking = [];

            // 1‰Ωç„Äú: Êó¢„Å´50ÁÇπ„ÅßÊäú„Åë„Åü‰∫∫„Åü„Å°
            finalRanking = finalRanking.concat(clearOrder);

            // Ê¨°: ÊúÄÂæå„Åæ„ÅßÁîü„ÅçÊÆã„Å£„Å¶„ÅÑ„Åü‰∫∫ÔºàÂæóÁÇπÈñ¢‰øÇ„Å™„Åè„ÄÅÁîü„ÅçÊÆã„Çä„ÅåÂÅâ„ÅÑÔºâ
            // ‚Äª„ÇÇ„ÅóÁîü„ÅçÊÆã„Çä„ÅåË§áÊï∞„ÅÑ„ÇãÂ†¥Âêà„ÅØÂæóÁÇπÈ†Ü„Å´„Åô„ÇãÔºü‰ªäÂõû„ÅØ„ÄåÊÆã„Çä1‰∫∫„Å´„Å™„Å£„Åü„ÇâÁµÇ‰∫Ü„Äç„Å™„ÅÆ„ÅßÈÄöÂ∏∏„ÅØ1Âêç
            finalRanking = finalRanking.concat(survivors);

            // ÊúÄÂæå: Â§±Ê†ºËÄÖ„Åü„Å°ÔºàÂ§±Ê†º„ÅåÈÅÖ„Åã„Å£„ÅüÈ†Ü = Stack„ÅÆÂæå„Çç„ÅÆ„Åª„ÅÜ„ÅåÈ†Ü‰Ωç„ÅåÈ´ò„ÅÑÔºâ
            // Stack: [ÊúÄÂàù„ÅÆÂ§±Ê†ºËÄÖ, 2Áï™ÁõÆ„ÅÆÂ§±Ê†ºËÄÖ...] 
            // ÈÄÜÈ†Ü„Å´ÁµêÂêà„Åô„Çå„Å∞„ÄÅ2Áï™ÁõÆ„ÅÆÂ§±Ê†ºËÄÖ„ÅÆÊñπ„Åå‰∏ä‰Ωç„Å´Êù•„Çã
            finalRanking = finalRanking.concat(eliminatedStack.reverse());

            // ÁîªÈù¢Ë°®Á§∫
            const resultList = document.getElementById('result-list');
            resultList.innerHTML = "";

            finalRanking.forEach((p, i) => {
                let rankStyle = "text-white";
                let icon = `${i+1}‰Ωç`;
                if(i===0) { rankStyle="text-yellow-400 font-bold text-xl"; icon="ü•á 1st"; }
                if(i===1) { rankStyle="text-gray-300 font-bold text-lg"; icon="ü•à 2nd"; }
                if(i===2) { rankStyle="text-orange-400 font-bold"; icon="ü•â 3rd"; }

                // „Çπ„ÉÜ„Éº„Çø„ÇπË£úË∂≥
                let detail = `${p.score}pt`;
                if (p.status === STATUS.CLEARED) detail = "Clear!";
                if (p.status === STATUS.ELIMINATED) detail = "Â§±Ê†º";

                resultList.innerHTML += `
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                        <div class="${rankStyle}">${icon} <span class="ml-2">${p.name}</span></div>
                        <div class="text-gray-400 text-sm">${detail}</div>
                    </div>
                `;
            });

            showView('view-result');
        }
    </script>
</body>
</html>
