<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MÃ¶lkky Online Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #111827; color: white; font-family: 'Roboto', sans-serif; touch-action: manipulation; }
        .view-section { display: none; min-height: 100vh; flex-direction: column; }
        .active-view { display: flex; }
        
        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .score-btn {
            width: 60px; height: 60px; font-size: 1.8rem; font-weight: 900;
            display: flex; align-items: center; justify-content: center; padding: 0;
            transition: all 0.2s; position: relative;
        }
        .score-btn:active { transform: scale(0.92); }
        .btn-snipe { border-radius: 50%; background: linear-gradient(135deg, #e4c49f 0%, #c89f72 100%); color: #3e2723; border: 2px solid #5d4037; box-shadow: 0 4px 0 #8d6e63; }
        .btn-break { border-radius: 12px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: #ffffff; border: 1px solid #93c5fd; box-shadow: 0 4px 0 #1d4ed8; }
        .btn-miss { background: linear-gradient(to bottom, #ef4444, #dc2626); box-shadow: 0 4px 0 #991b1b; }
        .btn-miss:active { transform: translateY(2px); box-shadow: 0 1px 0 #991b1b; }
        .current-turn { background: rgba(251, 191, 36, 0.15); border-left: 4px solid #fbbf24; }
        .row-eliminated { opacity: 0.4; filter: grayscale(100%); }
        .row-cleared { background: rgba(16, 185, 129, 0.15); border-left: 4px solid #10b981; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-center: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(4px);
        }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1f2937; border-radius: 20px; padding: 2rem; width: 85%; max-width: 320px; text-align: center; border: 1px solid #374151; transform: scale(0.9); transition: transform 0.2s; }
        .modal-active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="max-w-md mx-auto bg-gray-900 shadow-2xl overflow-hidden relative min-h-screen">

    <button onclick="goHome()" class="fixed top-4 left-4 z-50 w-12 h-12 bg-gray-800/80 backdrop-blur rounded-full flex items-center justify-center shadow-lg border border-gray-600 hover:bg-gray-700 transition active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
        </svg>
    </button>

    <div id="view-title" class="view-section active-view justify-center items-center p-6 text-center space-y-6 bg-gray-900">
        <div class="mb-2">
            <h1 class="text-5xl font-black text-yellow-500 mb-2 tracking-tighter drop-shadow-lg">MÃ¶lkky<br>Battle</h1>
            <p class="text-gray-400 text-sm font-bold tracking-widest">ONLINE SYNC</p>
        </div>

        <div class="w-full bg-gray-800 p-4 rounded-xl border border-gray-700">
            <label class="text-xs text-gray-400 block mb-2 text-left">åˆè¨€è‘‰ï¼ˆãƒ«ãƒ¼ãƒ IDï¼‰</label>
            <input type="text" id="room-id" value="room1" class="w-full p-3 bg-gray-900 text-white rounded-lg border border-gray-600 font-bold text-center tracking-widest uppercase focus:border-yellow-500 outline-none" placeholder="ä¾‹: ROOM1">
            <p class="text-[10px] text-gray-500 mt-2 text-left">â€»åŒã˜åˆè¨€è‘‰ã®äººã¨ãƒ‡ãƒ¼ã‚¿ãŒå…±æœ‰ã•ã‚Œã¾ã™</p>
        </div>
        
        <button onclick="connectAndSetup()" class="w-full py-4 bg-yellow-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-yellow-500 transition transform hover:-translate-y-1 flex items-center justify-center">
            <span class="mr-2">ğŸ”¥</span> è©¦åˆã‚’å§‹ã‚ã‚‹ / å‚åŠ 
        </button>

        <button onclick="connectAndRecords()" class="w-full py-4 bg-gray-800 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-gray-700 transition transform hover:-translate-y-1 flex items-center justify-center border border-gray-700">
            <span class="mr-2">ğŸ“Š</span> è¨˜éŒ²ã‚’è¦‹ã‚‹
        </button>
    </div>

    <div id="view-setup" class="view-section p-6 bg-gray-900 pt-20">
        <h2 class="text-xl font-bold text-center mb-6 border-b border-gray-700 pb-2 text-gray-300">PLAYER ENTRY</h2>
        <div class="flex-grow overflow-y-auto space-y-3 mb-4 pr-1" id="player-input-list">
            </div>
        <button onclick="addPlayerInput()" class="w-full py-3 mb-4 bg-gray-800 text-gray-400 rounded-xl text-sm border-dashed border-2 border-gray-700 font-bold hover:bg-gray-750">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        <button onclick="initGame()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-500 transition">GAME START</button>
    </div>

    <div id="view-game" class="view-section">
        <div class="bg-gray-800 p-2 flex-grow overflow-y-auto custom-scrollbar pt-16">
            <table class="w-full text-left border-collapse">
                <thead class="text-xs text-gray-500 border-b border-gray-700 sticky top-0 bg-gray-800 z-10">
                    <tr>
                        <th class="pb-2 pl-3 pt-2">NAME</th>
                        <th class="pb-2 text-center pt-2">MISS</th>
                        <th class="pb-2 text-right pr-4 pt-2">SCORE</th>
                    </tr>
                </thead>
                <tbody id="scoreboard-body" class="text-sm font-bold"></tbody>
            </table>
        </div>
        <div class="bg-gray-900 pb-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-20 relative">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-800 mb-2">
                <div>
                    <span class="text-[10px] text-green-400 font-bold tracking-widest block mb-1">THROWING NEXT</span>
                    <span id="current-player-name" class="text-xl font-black text-white tracking-tight truncate max-w-[150px] block">Wait...</span>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-gray-500 font-bold tracking-widest block mb-1">TARGET</span>
                    <span class="text-3xl font-black text-yellow-400 leading-none">50</span>
                </div>
            </div>
            <div class="flex justify-center mb-4 px-4">
                <div class="bg-gray-800 p-1 rounded-xl flex w-full max-w-xs border border-gray-700">
                    <button id="tab-snipe" onclick="switchMode('snipe')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400">ğŸ¯ 1æœ¬ (Snipe)</button>
                    <button id="tab-break" onclick="switchMode('break')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400">ğŸ’¥ è¤‡æ•° (Break)</button>
                </div>
            </div>
            <div class="flex flex-col items-center gap-3 mb-5 px-2">
                <div class="flex gap-4"> 
                    <button class="score-btn" onclick="updateScore(7)">7</button>
                    <button class="score-btn" onclick="updateScore(9)">9</button>
                    <button class="score-btn" onclick="updateScore(8)">8</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="score-btn" onclick="updateScore(5)">5</button>
                    <button class="score-btn" onclick="updateScore(11)">11</button>
                    <button class="score-btn" onclick="updateScore(12)">12</button>
                    <button class="score-btn" onclick="updateScore(6)">6</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="score-btn" onclick="updateScore(3)">3</button>
                    <button class="score-btn" onclick="updateScore(10)">10</button>
                    <button class="score-btn" onclick="updateScore(4)">4</button>
                </div>
                <div class="flex gap-4"> 
                    <button class="score-btn" onclick="updateScore(1)">1</button>
                    <button class="score-btn" onclick="updateScore(2)">2</button>
                </div>
            </div>
            <div class="px-6">
                <button onclick="updateScore(0)" class="w-full py-4 btn-miss text-white font-black rounded-2xl text-lg tracking-wider active:bg-red-700 transition">MISS ( 0 )</button>
            </div>
        </div>
    </div>

    <div id="view-result" class="view-section justify-center items-center p-6 text-center bg-gray-900 pt-20">
        <h2 class="text-4xl text-yellow-400 font-black mb-8 tracking-tighter drop-shadow-md">GAME SET!</h2>
        <div class="w-full bg-gray-800 rounded-2xl p-6 mb-8 text-left space-y-3 shadow-lg border border-gray-700" id="result-list"></div>
        <button onclick="goHome()" class="w-full py-4 bg-gray-700 text-white rounded-xl font-bold hover:bg-gray-600 transition">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
    </div>

    <div id="view-records" class="view-section p-6 bg-gray-900 pt-20 overflow-y-auto">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-black text-white">ROOM STATS</h2>
            <p class="text-xs text-gray-500" id="record-room-id-display">Room: ---</p>
        </div>
        <div class="mb-6">
            <select id="record-player-select" onchange="analyzeRecords()" class="w-full p-3 bg-gray-800 text-white rounded-xl border border-gray-700 font-bold outline-none focus:border-yellow-500"></select>
        </div>
        <div id="stats-container" class="space-y-6 hidden">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl text-center border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold">ç·æŠ•æ“²æ•°</div>
                    <div id="stat-total-throws" class="text-3xl font-black text-white mt-1">0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl text-center border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold">50ç‚¹å›æ•°</div>
                    <div id="stat-wins" class="text-3xl font-black text-yellow-400 mt-1">0</div>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                <h3 class="text-sm font-bold text-gray-300 mb-4">ğŸ¯ ã‚¹ã‚¿ã‚¤ãƒ«æ¯”ç‡</h3>
                <div class="flex justify-between text-xs font-bold mb-1"><span class="text-yellow-500" id="text-snipe">Snipe 0%</span><span class="text-blue-500" id="text-break">Break 0%</span></div>
                <div class="w-full h-3 bg-gray-700 rounded-full flex overflow-hidden"><div id="bar-snipe" class="bg-yellow-500 h-full w-0"></div><div id="bar-break" class="bg-blue-500 h-full w-0"></div></div>
            </div>
        </div>
        <div id="no-data-msg" class="text-center text-gray-500 py-10">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­ã€ã¾ãŸã¯å±¥æ­´ãªã—</div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-icon" class="text-5xl mb-4">âš ï¸</div>
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2"></h3>
            <p id="modal-message" class="text-gray-400 text-sm mb-6 leading-relaxed"></p>
            <div id="modal-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’è¨­å®šæ¸ˆã¿ã§ã™
        const firebaseConfig = {
            apiKey: "AIzaSyAkxCP38Q9t4ggTn3ippGqp1ood-yfkjls",
            authDomain: "molkkystatus.firebaseapp.com",
            projectId: "molkkystatus",
            storageBucket: "molkkystatus.firebasestorage.app",
            messagingSenderId: "666672171664",
            appId: "1:666672171664:web:2b23bab0c3ff77943e6615",
            measurementId: "G-Q1TBBHQ90Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        let roomId = "room1";
        let gameState = null;
        let unsubscribe = null;
        let currentMode = 'snipe';

        window.goHome = () => {
            if(unsubscribe) unsubscribe(); // ç›£è¦–åœæ­¢
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById('view-title').classList.add('active-view');
        };

        window.connectAndSetup = async () => {
            roomId = document.getElementById('room-id').value.toLowerCase();
            if(!roomId) return alert("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            // ãƒ«ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–é–‹å§‹
            startListening();
        };

        window.connectAndRecords = async () => {
            roomId = document.getElementById('room-id').value.toLowerCase();
            if(!roomId) return alert("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            document.getElementById('record-room-id-display').innerText = `Room: ${roomId.toUpperCase()}`;
            
            showView('view-records');
            loadRecords();
        };

        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ ---
        function startListening() {
            const docRef = doc(db, "rooms", roomId);
            
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    gameState = docSnap.data();
                    
                    // ç”»é¢ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
                    if(gameState.status === 'setup') {
                        showView('view-setup');
                        renderSetupPlayers();
                    } else if(gameState.status === 'playing') {
                        showView('view-game');
                        updateGameView();
                    } else if(gameState.status === 'finished') {
                        showView('view-result');
                        renderResult();
                    }
                } else {
                    // éƒ¨å±‹ãŒãªã„å ´åˆã¯ä½œæˆï¼ˆSetupç”»é¢ã¸ï¼‰
                    gameState = {
                        status: 'setup',
                        players: [{name: 'Player 1', score: 0, miss: 0, status: 'playing'}],
                        logs: []
                    };
                    setDoc(docRef, gameState);
                    showView('view-setup');
                    renderSetupPlayers();
                }
            });
        }

        // --- View Helpers ---
        function showView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(id).classList.add('active-view');
        }

        function showModal(icon, title, msg, actions) {
            document.getElementById('modal-icon').innerText = icon;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerHTML = msg;
            const container = document.getElementById('modal-actions');
            container.innerHTML = '';
            actions.forEach(a => {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-3 px-4 rounded-lg font-bold text-sm ${a.primary?'bg-blue-600 text-white':'bg-gray-700 text-gray-300'}`;
                btn.innerText = a.text;
                btn.onclick = () => { closeModal(); if(a.onClick) a.onClick(); };
                container.appendChild(btn);
            });
            document.getElementById('modal-overlay').classList.add('modal-active');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('modal-active'); }

        window.switchMode = (mode) => {
            currentMode = mode;
            if(mode === 'snipe') {
                document.getElementById('tab-snipe').className = "flex-1 py-2 rounded-lg text-xs font-bold bg-yellow-600 text-white shadow-md";
                document.getElementById('tab-break').className = "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-700";
                document.querySelectorAll('.score-btn').forEach(b => { b.classList.remove('btn-break'); b.classList.add('btn-snipe'); });
            } else {
                document.getElementById('tab-snipe').className = "flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-700";
                document.getElementById('tab-break').className = "flex-1 py-2 rounded-lg text-xs font-bold bg-blue-600 text-white shadow-md";
                document.querySelectorAll('.score-btn').forEach(b => { b.classList.remove('btn-snipe'); b.classList.add('btn-break'); });
            }
        };

        // --- Setup Logic ---
        function renderSetupPlayers() {
            const list = document.getElementById('player-input-list');
            list.innerHTML = '';
            gameState.players.forEach((p, i) => {
                const input = document.createElement('input');
                input.value = p.name;
                input.className = "w-full p-4 bg-gray-800 rounded-xl border border-gray-700 text-white font-bold mb-2";
                input.onchange = (e) => {
                    gameState.players[i].name = e.target.value;
                    updateDoc(doc(db, "rooms", roomId), { players: gameState.players });
                };
                list.appendChild(input);
            });
        }

        window.addPlayerInput = () => {
            gameState.players.push({name: `Player ${gameState.players.length+1}`, score: 0, miss: 0, status: 'playing'});
            updateDoc(doc(db, "rooms", roomId), { players: gameState.players });
        };

        window.initGame = () => {
            gameState.status = 'playing';
            gameState.currentIndex = 0;
            gameState.clearOrder = [];
            gameState.eliminatedStack = [];
            updateDoc(doc(db, "rooms", roomId), gameState);
        };

        // --- Game Logic ---
        function updateGameView() {
            // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æ›´æ–°
            const tbody = document.getElementById('scoreboard-body');
            tbody.innerHTML = '';
            gameState.players.forEach((p, i) => {
                const tr = document.createElement('tr');
                let rowClass = "border-b border-gray-700";
                let icon = "";
                let style = "text-gray-300";
                if(p.status === 'eliminated') { rowClass = "row-eliminated"; icon = "ğŸ’€"; }
                else if(p.status === 'cleared') { rowClass = "row-cleared"; icon = "ğŸ‘‘"; style = "text-green-400"; }
                else if(i === gameState.currentIndex) { rowClass = "current-turn border-b border-yellow-900"; style = "text-white"; }
                
                tr.className = rowClass;
                let missHtml = "";
                for(let m=0; m<3; m++) missHtml += (m<p.miss) ? "âŒ" : "â—";
                
                tr.innerHTML = `
                    <td class="py-3 pl-3 flex items-center ${style}"><span class="w-5 text-center mr-1">${icon}</span>${p.name}${i===gameState.currentIndex && p.status==='playing' ? '<span class="text-xs ml-2 text-yellow-400 animate-pulse">â—€</span>':''}</td>
                    <td class="text-center text-[10px] text-gray-500">${missHtml}</td>
                    <td class="text-right pr-4 font-mono text-xl ${p.status==='cleared'?'text-green-400':'text-white'}">${p.status==='eliminated'?'-':p.score}</td>
                `;
                tbody.appendChild(tr);
            });

            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
            if(gameState.players[gameState.currentIndex]) {
                document.getElementById('current-player-name').innerText = gameState.players[gameState.currentIndex].name;
            }
            switchMode('snipe'); // Reset to snipe mode visual
        }

        window.updateScore = async (points) => {
            // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ“ä½œ
            const newState = JSON.parse(JSON.stringify(gameState));
            const player = newState.players[newState.currentIndex];
            const scoreBefore = player.score;

            // ãƒ­ã‚°ä½œæˆ
            const logEntry = {
                player: player.name,
                points: points,
                score_before: scoreBefore,
                mode: points === 0 ? 'miss' : currentMode,
                is_miss: points === 0,
                is_finish: (player.score + points === 50)
            };
            if(!newState.logs) newState.logs = [];
            newState.logs.push(logEntry);

            // ã‚¹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
            let message = null;
            if(points === 0) {
                player.miss++;
                if(player.miss >= 3) {
                    player.status = 'eliminated';
                    if(!newState.eliminatedStack) newState.eliminatedStack = [];
                    newState.eliminatedStack.push(player.name);
                    message = {icon:'ğŸ’€', title:'å¤±æ ¼', text:`${player.name}ã•ã‚“ãŒè„±è½ã—ã¾ã—ãŸ`};
                }
            } else {
                player.miss = 0;
                let next = player.score + points;
                if(next === 50) {
                    player.score = 50;
                    player.status = 'cleared';
                    if(!newState.clearOrder) newState.clearOrder = [];
                    newState.clearOrder.push(player.name);
                    message = {icon:'ğŸ‰', title:'CLEAR!', text:`${player.name}ã•ã‚“ãŒ50ç‚¹é”æˆï¼`};
                } else if(next > 50) {
                    player.score = 25;
                    message = {icon:'â†©ï¸', title:'OVER', text:`${player.name}ã•ã‚“25ç‚¹ã«æˆ»ã‚Šã¾ã™`};
                } else {
                    player.score = next;
                }
            }

            // çµ‚äº†åˆ¤å®š
            const active = newState.players.filter(p => p.status === 'playing');
            if(active.length <= 1) {
                // çµ‚äº†
                newState.status = 'finished';
                // é †ä½ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯ç°¡æ˜“çš„ã«
                const survivors = active.map(p => p.name);
                const elims = newState.eliminatedStack ? newState.eliminatedStack.reverse() : [];
                const clears = newState.clearOrder || [];
                // çµæœä¿å­˜ç”¨
                newState.ranking = [...clears, ...survivors, ...elims];
            } else {
                // æ¬¡ã®ã‚¿ãƒ¼ãƒ³
                let loop = 0;
                do {
                    newState.currentIndex = (newState.currentIndex + 1) % newState.players.length;
                    loop++;
                } while (newState.players[newState.currentIndex].status !== 'playing' && loop < newState.players.length);
            }

            // DBæ›´æ–°ï¼ˆå…¨å“¡ã«åŒæœŸã•ã‚Œã‚‹ï¼‰
            await updateDoc(doc(db, "rooms", roomId), newState);

            if(message && newState.status !== 'finished') {
                showModal(message.icon, message.title, message.text, [{text:'OK', primary:false}]);
            }
        };

        // --- Result & Stats ---
        function renderResult() {
            const list = document.getElementById('result-list');
            list.innerHTML = '';
            const ranking = gameState.ranking || [];
            ranking.forEach((name, i) => {
                let rankColor = i===0?"text-yellow-400":i===1?"text-gray-300":"text-orange-400";
                list.innerHTML += `<div class="flex justify-between border-b border-gray-700 py-3"><div class="${rankColor} font-bold text-xl w-12">${i+1}th</div><div class="text-white font-bold">${name}</div></div>`;
            });
        }

        async function loadRecords() {
            const docSnap = await getDoc(doc(db, "rooms", roomId));
            if(!docSnap.exists()) {
                document.getElementById('no-data-msg').innerText = "ã“ã®éƒ¨å±‹ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“";
                return;
            }
            const data = docSnap.data();
            const logs = data.logs || [];
            
            if(logs.length === 0) {
                document.getElementById('no-data-msg').style.display = 'block';
                document.getElementById('stats-container').style.display = 'none';
                return;
            }
            
            document.getElementById('no-data-msg').style.display = 'none';
            document.getElementById('stats-container').style.display = 'block';

            const players = [...new Set(logs.map(l => l.player))];
            const select = document.getElementById('record-player-select');
            select.innerHTML = '';
            players.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
            
            window.analyzeRecords = () => {
                const target = select.value;
                const myLogs = logs.filter(l => l.player === target);
                document.getElementById('stat-total-throws').innerText = myLogs.length;
                document.getElementById('stat-wins').innerText = myLogs.filter(l => l.is_finish).length;
                
                const s = myLogs.filter(l => l.mode === 'snipe').length;
                const b = myLogs.filter(l => l.mode === 'break').length;
                const total = s + b || 1;
                const sRate = Math.round(s/total*100);
                document.getElementById('text-snipe').innerText = `Snipe ${sRate}%`;
                document.getElementById('text-break').innerText = `Break ${100-sRate}%`;
                document.getElementById('bar-snipe').style.width = `${sRate}%`;
                document.getElementById('bar-break').style.width = `${100-sRate}%`;
            };
            analyzeRecords();
        }
    </script>
</body>
</html>
