<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MÃ¶lkky Stats Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { 
            background-color: #111827; color: white; 
            font-family: 'Roboto', 'Noto Sans JP', sans-serif; 
            touch-action: manipulation;
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
        }
        
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆåˆ¶å¾¡ */
        #app-container { width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* --- ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ (ä¿®æ­£ç®‡æ‰€: å®Œå…¨ãªæ­£å††ã«å›ºå®š) --- */
        .score-btn {
            width: 54px;  /* å¹…ã‚’å›ºå®š */
            height: 54px; /* é«˜ã•ã‚’å›ºå®š */
            flex-shrink: 0; /* ç”»é¢ãŒç‹­ãã¦ã‚‚æ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            font-size: 1.5rem; font-weight: 900;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; 
            transition: transform 0.1s; 
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            margin: 0 auto; /* ä¸­å¤®å¯„ã› */
        }
        .score-btn:active { transform: scale(0.92) translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        
        .pin-row { 
            display: flex; 
            justify-content: center; 
            gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
            margin-bottom: 8px; 
        }

        .mode-snipe .score-btn { background: radial-gradient(circle at 30% 30%, #e4c49f, #c89f72); color: #3e2723; border: 2px solid #5d4037; border-radius: 50%; }
        .mode-break .score-btn { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border: 1px solid #93c5fd; border-radius: 12px; }
        .btn-miss { background: linear-gradient(to bottom, #ef4444, #dc2626); box-shadow: 0 3px 0 #991b1b; }
        .btn-miss:active { transform: translateY(2px); box-shadow: 0 1px 0 #991b1b; }

        /* --- ãã®ä»–ãƒ‘ãƒ¼ãƒ„ --- */
        .player-detail { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #1f2937; }
        .detail-open { max-height: 1200px; } 

        .stat-label { font-size: 0.6rem; color: #9ca3af; display: block; line-height: 1; margin-top: 3px; font-weight: bold; font-family: 'Noto Sans JP', sans-serif; }
        .stat-val { font-size: 1.1rem; font-weight: 900; font-family: 'Roboto', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        /* ãƒãƒ£ãƒ¼ãƒˆã®ã‚¿ãƒƒãƒ—ã‚®ãƒŸãƒƒã‚¯ */
        .chart-label-group { cursor: pointer; }
        .chart-value-text { font-weight: 900; fill: #facc15; font-size: 14px; text-anchor: middle; display: none; }
        .chart-label-group:active .chart-text, .chart-label-group:hover .chart-text { display: none; }
        .chart-label-group:active .chart-value-text, .chart-label-group:hover .chart-value-text { display: block; }
    </style>
</head>
<body class="max-w-md mx-auto relative shadow-2xl">

    <button onclick="router('home')" class="fixed top-3 left-3 z-50 w-10 h-10 bg-gray-800/90 backdrop-blur rounded-full flex items-center justify-center shadow-lg border border-gray-600 hover:bg-gray-700 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
    </button>

    <div id="app-container"></div>

    <script>
        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ (ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿) ---
        // â€» æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€1è©¦åˆ10æŠ•ã¨ã—ã¦å†…éƒ¨æ•°å€¤ã‚’é€†ç®—è¨­å®š
        // â€» æœªè¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿(ç‹™æ’ƒç‡ãªã©)ã¯ç”»é¢ä¸Šã§ã¯ "-" (ç©ºæ¬„) ã«ãªã‚Šã¾ã™
        const LEGACY_STATS = {
            "å‰è°·æ‚ ": { 
                games: 66, wins: 25, 
                // ãƒ•ã‚¡ã‚¦ãƒ«ç‡33% -> å‘½ä¸­ç‡67%
                // å¹³å‡4ç‚¹ -> åˆè¨ˆç‚¹ = æŠ•æ•° * 4
                throws: 660, misses: 218, points: 2640 
            },
            "çŸ³äº•å±±æ‹“ç™»": { 
                games: 61, wins: 26, 
                // ãƒ•ã‚¡ã‚¦ãƒ«ç‡23% -> å‘½ä¸­ç‡77%
                throws: 610, misses: 140, points: 2440
            },
            "æ£®å²¡å‡œå¤ªéƒ": { 
                games: 35, wins: 14, 
                // ãƒ•ã‚¡ã‚¦ãƒ«ç‡28% -> å‘½ä¸­ç‡72%
                throws: 350, misses: 98, points: 1400
            }
        };
        
        // --- State ---
        const STATUS = { PLAYING: 'playing', CLEARED: 'cleared', ELIMINATED: 'eliminated' };
        let players = [], currentIndex = 0, clearOrder = [], eliminatedStack = [], currentMode = 'snipe';
        const app = document.getElementById('app-container');

        // --- Router (ç”»é¢åˆ‡ã‚Šæ›¿ãˆ) ---
        function router(page) {
            app.innerHTML = ''; // ç”»é¢ãƒªã‚»ãƒƒãƒˆï¼

            if (page === 'home') renderHome();
            else if (page === 'setup') renderSetup();
            else if (page === 'game') renderGame();
            else if (page === 'result') renderResult();
            else if (page === 'records') renderRecords();
        }

        // åˆæœŸè¡¨ç¤º
        router('home');

        // --- 1. HOMEç”»é¢ ---
        function renderHome() {
            app.innerHTML = `
                <div class="flex-grow flex flex-col justify-center items-center p-6 bg-gray-900">
                    <div class="mb-10 text-center">
                        <h1 class="text-6xl font-black text-yellow-500 mb-2 tracking-tighter drop-shadow-lg leading-none">MÃ¶lkky<br>Stats</h1>
                        <p class="text-gray-400 text-sm font-bold tracking-widest uppercase">Official Log App</p>
                    </div>
                    <div class="w-full space-y-4">
                        <button onclick="router('setup')" class="w-full py-5 bg-yellow-600 text-white rounded-2xl font-bold text-2xl shadow-lg hover:bg-yellow-500 transition transform hover:-translate-y-1 flex items-center justify-center">
                            <span class="mr-3">ğŸ”¥</span> æ–°ã—ã„è©¦åˆ
                        </button>
                        <button onclick="router('records')" class="w-full py-5 bg-gray-800 text-gray-300 rounded-2xl font-bold text-xl shadow-lg hover:bg-gray-700 transition transform hover:-translate-y-1 flex items-center justify-center border border-gray-700">
                            <span class="mr-3">ğŸ“Š</span> è¨˜éŒ²ãƒ»åˆ†æ
                        </button>
                    </div>
                </div>
            `;
        }

        // --- 2. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ ---
        function renderSetup() {
            app.innerHTML = `
                <div class="p-4 bg-gray-900 h-full flex flex-col">
                    <div class="pt-12 pb-4 text-center"><h2 class="text-xl font-bold text-white tracking-widest border-b-2 border-yellow-600 inline-block pb-1">PLAYER ENTRY</h2></div>
                    <div class="flex-grow overflow-y-auto space-y-3 px-2 custom-scrollbar" id="player-input-list"></div>
                    <div class="mt-4 space-y-3">
                        <button onclick="addPlayerInput()" class="w-full py-3 bg-gray-800 text-gray-400 rounded-xl text-sm border-dashed border-2 border-gray-700 font-bold hover:bg-gray-750">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
                        <button onclick="startGame()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-blue-500 transition">GAME START</button>
                    </div>
                </div>
            `;
            if(players.length === 0) renderInputs(['å‰è°·æ‚ ', 'çŸ³äº•å±±æ‹“ç™»', 'æ£®å²¡å‡œå¤ªéƒ']);
            else renderInputs(players.map(p => p.name));
        }

        function renderInputs(names) {
            const list = document.getElementById('player-input-list');
            list.innerHTML = '';
            names.forEach(n => {
                const i = document.createElement('input'); i.value = n;
                i.className = "w-full p-4 bg-gray-800 rounded-xl border border-gray-700 text-white font-bold mb-2";
                list.appendChild(i);
            });
        }
        function addPlayerInput() {
            const list = document.getElementById('player-input-list');
            const i = document.createElement('input'); i.value = "Player " + (list.children.length + 1);
            i.className = "w-full p-4 bg-gray-800 rounded-xl border border-gray-700 text-white font-bold mb-2";
            list.appendChild(i);
        }

        function startGame() {
            const inputs = document.querySelectorAll('#player-input-list input');
            players = []; clearOrder = []; eliminatedStack = [];
            inputs.forEach(i => {
                if(i.value.trim() !== "") players.push({
                    name: i.value, score: 0, miss: 0, status: STATUS.PLAYING,
                    stats: { snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0 }
                });
            });
            if(players.length < 1) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“");
            currentIndex = 0; switchMode('snipe'); 
            router('game');
        }

        // --- 3. ã‚²ãƒ¼ãƒ ç”»é¢ ---
        function renderGame() {
            app.innerHTML = `
                <div class="flex-grow overflow-y-auto custom-scrollbar pt-14 px-1 pb-2 bg-gray-800">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-500 sticky top-0 bg-gray-800 z-10 shadow-sm">
                            <tr><th class="pb-2 pl-3 pt-2">NAME</th><th class="pb-2 text-center pt-2">MISS</th><th class="pb-2 text-right pr-4 pt-2">SCORE</th></tr>
                        </thead>
                        <tbody id="scoreboard-body" class="text-sm font-bold"></tbody>
                    </table>
                </div>
                <div class="flex-none bg-gray-900 pb-8 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.5)] z-20 relative px-3">
                    <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 mb-2">
                        <div class="overflow-hidden"><span class="text-[10px] text-green-400 font-bold tracking-widest block">THROWING NEXT</span><span id="current-player-name" class="text-xl font-black text-white tracking-tight truncate block">Player</span></div>
                        <div class="text-right flex-none pl-4"><span class="text-[10px] text-gray-500 font-bold tracking-widest block">TARGET</span><span class="text-3xl font-black text-yellow-400 leading-none">50</span></div>
                    </div>
                    <div class="flex justify-center mb-4">
                        <div class="bg-gray-800 p-1 rounded-xl flex w-full max-w-xs border border-gray-700">
                            <button id="tab-snipe" onclick="switchMode('snipe')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400">ğŸ¯ Snipe</button>
                            <button id="tab-break" onclick="switchMode('break')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-400">ğŸ’¥ Break</button>
                        </div>
                    </div>
                    <div id="pin-container" class="mode-snipe flex flex-col items-center">
                        <div class="pin-row"><button class="score-btn" onclick="inputScore(7)">7</button><button class="score-btn" onclick="inputScore(9)">9</button><button class="score-btn" onclick="inputScore(8)">8</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="inputScore(5)">5</button><button class="score-btn" onclick="inputScore(11)">11</button><button class="score-btn" onclick="inputScore(12)">12</button><button class="score-btn" onclick="inputScore(6)">6</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="inputScore(3)">3</button><button class="score-btn" onclick="inputScore(10)">10</button><button class="score-btn" onclick="inputScore(4)">4</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="inputScore(1)">1</button><button class="score-btn" onclick="inputScore(2)">2</button></div>
                    </div>
                    <div class="mt-2 px-6"><button onclick="inputScore(0)" class="w-full py-3 btn-miss text-white font-black rounded-xl text-lg tracking-wider active:bg-red-700 transition">MISS (0)</button></div>
                </div>
            `;
            updateScoreboard();
            switchMode('snipe'); 
        }

        function switchMode(mode) {
            currentMode = mode;
            const c = document.getElementById('pin-container');
            const bS = document.getElementById('tab-snipe'), bB = document.getElementById('tab-break');
            if(!c) return;
            if(mode==='snipe') {
                c.classList.remove('mode-break'); c.classList.add('mode-snipe');
                bS.className="flex-1 py-2 rounded-lg text-xs font-bold bg-yellow-600 text-white shadow-md";
                bB.className="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-700";
            } else {
                c.classList.remove('mode-snipe'); c.classList.add('mode-break');
                bS.className="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-700";
                bB.className="flex-1 py-2 rounded-lg text-xs font-bold bg-blue-600 text-white shadow-md";
            }
        }

        function inputScore(pnt) {
            const p = players[currentIndex];
            const prev = p.score;
            p.stats.throws++; p.stats.totalPoints += pnt;

            if(pnt===0) { p.stats.misses++; if(prev>=37) p.stats.clutchMisses++; } 
            else { if(currentMode==='snipe') p.stats.snipes++; else p.stats.breaks++; if(prev>=37) p.stats.clutchHits++; }

            if(pnt===0) {
                p.miss++;
                if(p.miss>=3) { p.status=STATUS.ELIMINATED; eliminatedStack.push(p); alert(`${p.name} å¤±æ ¼ï¼`); }
            } else {
                p.miss=0; let next=p.score+pnt;
                if(next===50) { p.score=50; p.status=STATUS.CLEARED; clearOrder.push(p); alert(`${p.name} ã‚¯ãƒªã‚¢ï¼`); }
                else if(next>50) { p.score=25; alert("ã‚ªãƒ¼ãƒãƒ¼ï¼25ç‚¹ã«æˆ»ã‚Šã¾ã™"); }
                else p.score=next;
            }
            const active = players.filter(pl=>pl.status===STATUS.PLAYING);
            if(active.length<=1) setTimeout(() => router('result'), 300);
            else proceedTurn();
            updateScoreboard();
        }

        function proceedTurn() {
            let loop=0;
            do { currentIndex=(currentIndex+1)%players.length; loop++; if(loop>players.length)break; }
            while(players[currentIndex].status!==STATUS.PLAYING);
            const el = document.getElementById('current-player-name');
            if(el) el.innerText = players[currentIndex].name;
        }

        function updateScoreboard() {
            const tb = document.getElementById('scoreboard-body');
            if(!tb) return;
            tb.innerHTML='';
            players.forEach((p,i)=>{
                const tr=document.createElement('tr');
                let st="text-gray-300 border-b border-gray-700", ic="";
                if(p.status===STATUS.ELIMINATED) {st="text-gray-600 bg-gray-800/50"; ic="ğŸ’€";}
                else if(p.status===STATUS.CLEARED) {st="text-green-400 bg-green-900/20"; ic="ğŸ‘‘";}
                else if(i===currentIndex) st="text-white bg-yellow-900/20 border-l-4 border-yellow-500";
                let mh=""; for(let m=0;m<3;m++) mh+=(m<p.miss)?"âŒ":"â—";
                tr.className=st;
                tr.innerHTML=`<td class="py-3 pl-3 flex items-center"><span class="w-5 text-center mr-1">${ic}</span>${p.name}</td><td class="text-center text-[10px] text-gray-500">${mh}</td><td class="text-right pr-4 font-mono text-xl">${p.status===STATUS.ELIMINATED?'-':p.score}</td>`;
                tb.appendChild(tr);
            });
        }

        // --- 4. çµæœç”»é¢ ---
        function renderResult() {
            const surv = players.filter(p=>p.status===STATUS.PLAYING);
            const rankObj = [...clearOrder, ...surv, ...eliminatedStack.reverse()];
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            const mData = { date: new Date().toISOString(), ranking: rankObj.map(p=>p.name), details: {} };
            rankObj.forEach(p=>mData.details[p.name]=p.stats);
            let hist = JSON.parse(localStorage.getItem('molkky_match_history')||'[]');
            hist.push(mData);
            localStorage.setItem('molkky_match_history', JSON.stringify(hist));

            // HTMLæç”»
            app.innerHTML = `
                <div class="view-section active-view justify-center items-center p-6 text-center bg-gray-900">
                    <h2 class="text-4xl text-yellow-400 font-black mb-6 tracking-tighter drop-shadow-md">GAME SET!</h2>
                    <div class="w-full bg-gray-800 rounded-2xl p-4 mb-6 text-left space-y-2 shadow-lg border border-gray-700 overflow-y-auto max-h-[50vh]" id="result-list"></div>
                    <div class="w-full space-y-3">
                        <button onclick="restartGame()" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-500 transition shadow-lg flex items-center justify-center"><span class="mr-2">ğŸ”„</span> ã‚‚ã†ä¸€å› (Rematch)</button>
                        <button onclick="router('home')" class="w-full py-4 bg-gray-700 text-white rounded-xl font-bold hover:bg-gray-600 transition border border-gray-600">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
                    </div>
                </div>
            `;

            const l = document.getElementById('result-list');
            rankObj.forEach((p,i)=>{
                let c=i===0?"text-yellow-400":i===1?"text-gray-300":"text-orange-400";
                l.innerHTML+=`<div class="flex justify-between border-b border-gray-700 py-3"><div class="${c} font-bold text-xl w-12">${i+1}th</div><div class="text-white font-bold">${p.name}</div><div class="text-gray-400 font-mono">${p.score}pt</div></div>`;
            });
        }

        function restartGame() {
            currentIndex=0; clearOrder=[]; eliminatedStack=[];
            players.forEach(p=>{
                p.score=0; p.miss=0; p.status=STATUS.PLAYING;
                p.stats={ snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0 };
            });
            router('game');
        }

        // --- 5. è¨˜éŒ²ãƒ»åˆ†æç”»é¢ ---
        function renderRecords() {
            app.innerHTML = `
                <div class="bg-gray-900 pt-16 flex flex-col h-full">
                    <div class="px-4 pb-4 bg-gray-900 border-b border-gray-800 z-10">
                        <h2 class="text-2xl font-black text-white text-center mb-1">RECORDS</h2>
                        <p class="text-xs text-gray-500 text-center mb-4">æˆ¦ç¸¾ãƒªã‚¹ãƒˆ (å¹³å‡é †ä½é †)</p>
                        <div class="flex items-end px-2 pb-2 text-gray-400 border-b border-gray-700">
                            <div class="w-10 text-center"><span class="block text-xs font-bold text-white leading-none">é †ä½</span><span class="block text-[8px] font-normal leading-none mt-1">RANK</span></div>
                            <div class="flex-1 pl-2"><span class="block text-xs font-bold text-white leading-none">åå‰</span><span class="block text-[8px] font-normal leading-none mt-1">NAME</span></div>
                            <div class="w-16 text-center"><span class="block text-xs font-bold text-white leading-none">å¹³å‡é †ä½</span><span class="block text-[8px] font-normal leading-none mt-1">AVG RANK</span></div>
                            <div class="w-12 text-center"><span class="block text-xs font-bold text-white leading-none">å¹³å‡ç‚¹</span><span class="block text-[8px] font-normal leading-none mt-1">AVG</span></div>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar px-4 pb-10" id="records-container"></div>
                </div>
            `;

            const hist = JSON.parse(localStorage.getItem('molkky_match_history')||'[]');
            const con = document.getElementById('records-container');
            
            if(hist.length===0) { 
                con.innerHTML='<div class="text-center text-gray-500 mt-10">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; 
                return; 
            }

            let pStats = {};
            hist.forEach(m => {
                m.ranking.forEach((name, idx) => {
                    if(!pStats[name]) pStats[name] = { 
                        ranks:[], wins:0, totalGames:0, lastPlaceCount:0,
                        stats:{snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0},
                        last10Stats: []
                    };
                    let ps = pStats[name];
                    ps.ranks.push(idx+1);
                    if(idx===0) ps.wins++;
                    if(idx===m.ranking.length-1) ps.lastPlaceCount++;
                    ps.totalGames++;
                    
                    if(m.details && m.details[name]) {
                        const d = m.details[name];
                        ps.stats.snipes += d.snipes||0; ps.stats.breaks += d.breaks||0; ps.stats.misses += d.misses||0;
                        ps.stats.clutchHits += d.clutchHits||0; ps.stats.clutchMisses += d.clutchMisses||0;
                        ps.stats.totalPoints += d.totalPoints||0; ps.stats.throws += d.throws||0;
                        ps.last10Stats.push({ 
                            rank: idx+1, 
                            scoreAvg: d.throws>0 ? (d.totalPoints/d.throws) : 0,
                            win: idx===0,
                            isLast: idx===m.ranking.length-1,
                            finished: m.details[name].totalPoints === 50 || d.score === 50
                        });
                    }
                });
            });

            let lb = Object.keys(pStats).map(n => {
                const d = pStats[n];
                const avg = d.ranks.reduce((a,b)=>a+b,0)/d.ranks.length;
                const ppt = d.stats.throws > 0 ? (d.stats.totalPoints / d.stats.throws) : 0;
                return { name:n, avgRank:avg, ppt:ppt, data:d };
            }).sort((a,b) => a.avgRank - b.avgRank);

            let curRank=1;
            lb.forEach((p, i) => {
                if(i>0 && p.avgRank > lb[i-1].avgRank) curRank=i+1;
                let rc = curRank===1?"rank-1":curRank===2?"rank-2":curRank===3?"rank-3":"text-white";

                const row = document.createElement('div');
                row.className = "bg-gray-800 rounded-xl mb-3 overflow-hidden border border-gray-700";
                row.innerHTML = `
                    <div class="flex items-center p-4 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('detail-open')">
                        <div class="w-10 text-center text-2xl font-black ${rc}">${curRank}</div>
                        <div class="flex-1 pl-2 font-bold text-lg text-white">${p.name}</div>
                        <div class="w-16 text-center font-mono font-bold text-yellow-400">${p.avgRank.toFixed(2)}</div>
                        <div class="w-12 text-center text-xs text-gray-500 font-mono">${p.ppt.toFixed(1)}</div>
                    </div>
                    <div class="player-detail px-4 bg-gray-900 border-t border-gray-800">
                        <div class="py-4 space-y-6">
                            <div class="chart-container text-center">
                                <h4 class="text-xs text-gray-400 mb-2 font-bold tracking-widest">PERFORMANCE RADAR (TAP LABEL)</h4>
                                ${genRadar(p.data)}
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <h4 class="text-xs text-gray-400 mb-3 font-bold border-b border-gray-700 pb-2 tracking-widest">ç›´è¿‘10æˆ¦ã®ä¸»è¦æŒ‡æ¨™</h4>
                                ${genLast10Stats(p.data.last10Stats)}
                            </div>
                            <div class="chart-container">
                                <h4 class="text-xs text-gray-400 mb-2 font-bold tracking-widest">RANKING HISTORY</h4>
                                ${genLine(p.data.ranks)}
                            </div>
                        </div>
                    </div>`;
                con.appendChild(row);
            });

            // æŒ‡æ¨™ã‚¬ã‚¤ãƒ‰
            const glossary = document.createElement('div');
            glossary.className = "mt-8 p-4 bg-gray-800/50 rounded-xl border border-gray-700 text-xs text-gray-400";
            glossary.innerHTML = `
                <h3 class="font-bold text-white mb-3 text-sm border-b border-gray-600 pb-2">ğŸ“Š æŒ‡æ¨™ã‚¬ã‚¤ãƒ‰</h3>
                <table class="w-full text-left border-collapse">
                    <tbody class="divide-y divide-gray-700">
                        <tr><th class="py-2 text-yellow-400 font-bold pr-2 whitespace-nowrap">å¹³å‡ç‚¹ (AVG)</th><td class="py-2">1æŠ•ã‚ãŸã‚Šã®å¹³å‡å¾—ç‚¹ (PPT)ã€‚<br>5.0ä»¥ä¸Šã§ä¸Šç´šè€…ã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">å‹ç‡</th><td class="py-2">1ä½ã‚’ç²å¾—ã—ãŸç¢ºç‡ã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">å‘½ä¸­ç‡</th><td class="py-2">ãƒŸã‚¹(0ç‚¹)ã‚’ã—ãªã‹ã£ãŸç¢ºç‡ã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">ç‹™æ’ƒç‡</th><td class="py-2">1æœ¬å€’ã—(Snipe)ã§å¾—ç‚¹ã—ãŸå‰²åˆã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">å‹è² å¼·ã•</th><td class="py-2">37ç‚¹ä»¥ä¸Šã§ã®å¾—ç‚¹æˆåŠŸç‡ã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">å¾—ç‚¹åŠ›</th><td class="py-2">å¹³å‡å¾—ç‚¹ã®é«˜ã•ã‚’0-100ã§è©•ä¾¡ã—ãŸã‚‚ã®ã€‚</td></tr>
                        <tr><th class="py-2 text-white font-bold pr-2">ãƒ©ã‚¹å›é¿</th><td class="py-2">æœ€ä¸‹ä½ã«ãªã‚‰ãªã‹ã£ãŸç¢ºç‡ã€‚</td></tr>
                    </tbody>
                </table>
                <div class="h-8"></div>`;
            con.appendChild(glossary);
        }

        // --- Helper Functions ---
        function genRadar(d) {
            const s = d.stats;
            const tThrows = s.snipes+s.breaks+s.misses||1;
            const vThrows = s.snipes+s.breaks||1;
            const tClutch = s.clutchHits+s.clutchMisses||1;

            const winRate = Math.round((d.wins/d.totalGames)*100);
            const acc = Math.round(((tThrows-s.misses)/tThrows)*100);
            const snipe = Math.round((s.snipes/vThrows)*100);
            const clutch = Math.round((s.clutchHits/tClutch)*100);
            const power = Math.min(100, Math.round(((s.totalPoints/s.throws || 0)/7) * 100));
            const avoidLast = Math.round(((d.totalGames - d.lastPlaceCount) / d.totalGames) * 100);

            const params = [
                {l:"å‹ç‡", e:"WIN RATE", v:winRate},
                {l:"å‘½ä¸­ç‡", e:"ACCURACY", v:acc},
                {l:"ç‹™æ’ƒç‡", e:"SNIPE", v:snipe},
                {l:"å‹è² å¼·ã•", e:"CLUTCH", v:clutch},
                {l:"å¾—ç‚¹åŠ›", e:"SCORING", v:power},
                {l:"ãƒ©ã‚¹å›é¿", e:"AVOID LAST", v:avoidLast}
            ];

            let pts="", lines="", lbls="";
            const cx=150, cy=150, r=90;
            for(let i=0;i<6;i++){
                const a = (Math.PI*2*i/6)-(Math.PI/2);
                const v = params[i].v;
                pts += `${cx+(r*(v/100))*Math.cos(a)},${cy+(r*(v/100))*Math.sin(a)} `;
                lines += `<line x1="${cx}" y1="${cy}" x2="${cx+r*Math.cos(a)}" y2="${cy+r*Math.sin(a)}" stroke="#374151"/>`;
                
                const lx = cx+(r+35)*Math.cos(a);
                const ly = cy+(r+35)*Math.sin(a);
                
                lbls += `<g class="chart-label-group" oncontextmenu="return false;">
                    <text x="${lx}" y="${ly-5}" font-size="12" font-weight="900" fill="#fff" text-anchor="middle" font-family="'Noto Sans JP', sans-serif" class="chart-text">${params[i].l}</text>
                    <text x="${lx}" y="${ly+8}" font-size="8" fill="#6b7280" text-anchor="middle" font-family="'Roboto', sans-serif" class="chart-text">${params[i].e}</text>
                    <text x="${lx}" y="${ly+4}" text-anchor="middle" class="chart-value-text">${params[i].v}%</text>
                </g>`;
            }
            return `<svg viewBox="0 0 300 300" class="w-full"><circle cx="150" cy="150" r="90" fill="none" stroke="#374151"/><circle cx="150" cy="150" r="45" fill="none" stroke="#374151" stroke-dasharray="2,2"/>${lines}<polygon points="${pts}" fill="rgba(250,204,21,0.4)" stroke="#facc15" stroke-width="2"/>${lbls}</svg>`;
        }

        function genLast10Stats(arr) {
            const last10 = arr.slice(-10);
            const wins = last10.filter(x=>x.win).length;
            const lastAvoid = last10.filter(x=>!x.isLast).length;
            const avgRank = (last10.reduce((a,b)=>a+b.rank,0)/last10.length).toFixed(1);
            const avgScore = (last10.reduce((a,b)=>a+b.scoreAvg,0)/last10.length).toFixed(1);
            const finishRate = Math.round((last10.filter(x=>x.finished).length / last10.length)*100); 
            
            return `
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-gray-700 p-2 rounded flex flex-col justify-center"><span class="stat-val text-yellow-400">${Math.round(wins/last10.length*100)}%</span><span class="stat-label">å‹ç‡</span></div>
                    <div class="bg-gray-700 p-2 rounded flex flex-col justify-center"><span class="stat-val text-white">${avgRank}</span><span class="stat-label">å¹³å‡é †ä½</span></div>
                    <div class="bg-gray-700 p-2 rounded flex flex-col justify-center"><span class="stat-val text-white">${avgScore}</span><span class="stat-label">å¹³å‡å¾—ç‚¹</span></div>
                    <div class="bg-gray-700 p-2 rounded flex flex-col justify-center"><span class="stat-val text-green-400">${finishRate}%</span><span class="stat-label">ä¸ŠãŒã‚Šç‡</span></div>
                    <div class="bg-gray-700 p-2 rounded flex flex-col justify-center col-span-2"><span class="stat-val text-blue-400">${Math.round(lastAvoid/last10.length*100)}%</span><span class="stat-label">ãƒ©ã‚¹å›é¿ç‡</span></div>
                </div>`;
        }

        function genLine(ranks) {
            const r = ranks.slice(-10);
            if(r.length<2) return '<div class="text-xs text-gray-600 text-center py-4">ãƒ‡ãƒ¼ã‚¿ä¸è¶³</div>';
            const w=280, h=80, step=w/(r.length-1);
            let p=""; r.forEach((rk,i)=>{ p+=`${i*step},${10+(rk-1)*20} `; });
            return `<svg viewBox="0 0 280 90" class="w-full h-24 bg-gray-800 rounded border border-gray-700"><polyline points="${p}" fill="none" stroke="#60a5fa" stroke-width="2"/>${r.map((rk,i)=>`<circle cx="${i*step}" cy="${10+(rk-1)*20}" r="3" fill="#60a5fa"/>`).join('')}</svg>`;
        }

        function generateDemoData() {
            if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¾ã™ã‹ï¼Ÿ")) return;
            const names=["ä½è—¤","éˆ´æœ¨","ç”°ä¸­","é«˜æ©‹"];
            let hist=[];
            for(let i=0; i<10; i++) {
                const shuf = [...names].sort(()=>0.5-Math.random());
                hist.push({
                    date: new Date().toISOString(), ranking: shuf,
                    details: {
                        [shuf[0]]: {snipes:6, breaks:1, misses:0, clutchHits:2, clutchMisses:0, totalPoints:50, throws:8},
                        [shuf[1]]: {snipes:3, breaks:4, misses:1, clutchHits:1, clutchMisses:1, totalPoints:42, throws:9},
                        [shuf[2]]: {snipes:2, breaks:2, misses:2, clutchHits:0, clutchMisses:0, totalPoints:28, throws:8},
                        [shuf[3]]: {snipes:8, breaks:0, misses:3, clutchHits:0, clutchMisses:0, totalPoints:35, throws:10}
                    }
                });
            }
            localStorage.setItem('molkky_match_history', JSON.stringify(hist));
            alert("ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†"); 
            router('records');
        }
    </script>
</body>
</html>


