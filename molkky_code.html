<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MÃ¶lkky Stats Pro (Final V5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #111827; color: white; font-family: 'Roboto', 'Noto Sans JP', sans-serif; touch-action: manipulation; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; }
        #app-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .score-btn { width: 54px; height: 54px; flex-shrink: 0; font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: transform 0.1s; position: relative; box-shadow: 0 4px 0 rgba(0,0,0,0.3); margin: 0 auto; }
        .score-btn:active { transform: scale(0.92) translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        .pin-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 8px; }
        .mode-snipe .score-btn { background: radial-gradient(circle at 30% 30%, #e4c49f, #c89f72); color: #3e2723; border: 2px solid #5d4037; border-radius: 50%; }
        .mode-break .score-btn { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border: 1px solid #93c5fd; border-radius: 12px; }
        .btn-miss { background: linear-gradient(to bottom, #ef4444, #dc2626); box-shadow: 0 3px 0 #991b1b; }
        .btn-miss:active { transform: translateY(2px); box-shadow: 0 1px 0 #991b1b; }
        .btn-undo { background: #4b5563; border: 1px solid #6b7280; box-shadow: 0 3px 0 #1f2937; color: #e5e7eb; }
        .btn-undo:active { transform: translateY(2px); box-shadow: 0 1px 0 #1f2937; }
        .player-detail { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #1f2937; }
        .detail-open { max-height: 1200px; } 
        .stat-label { font-size: 0.6rem; color: #9ca3af; display: block; line-height: 1; margin-top: 3px; font-weight: bold; font-family: 'Noto Sans JP', sans-serif; }
        .stat-val { font-size: 1.1rem; font-weight: 900; font-family: 'Roboto', sans-serif; }
        .chart-label-group { cursor: pointer; }
        .chart-value-text { font-weight: 900; fill: #facc15; font-size: 14px; text-anchor: middle; display: none; }
        .chart-label-group:active .chart-text, .chart-label-group:hover .chart-text { display: none; }
        .chart-label-group:active .chart-value-text, .chart-label-group:hover .chart-value-text { display: block; }
        .drag-handle { cursor: grab; touch-action: none; color: #6b7280; }
        .drag-handle:active { cursor: grabbing; color: #fff; }
        .sortable-ghost { opacity: 0.4; background: #374151; }
    </style>
</head>
<body class="max-w-md mx-auto relative shadow-2xl">

    <button onclick="window.router('home')" class="fixed top-3 left-3 z-50 w-10 h-10 bg-gray-800/90 backdrop-blur rounded-full flex items-center justify-center shadow-lg border border-gray-600 hover:bg-gray-700 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </button>

    <div id="app-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â˜…â˜…â˜… Firebaseè¨­å®š (ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„) â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyAkxCP38Q9t4ggTn3ippGqp1ood-yfkjls",
            authDomain: "molkkystatus.firebaseapp.com",
            projectId: "molkkystatus",
            storageBucket: "molkkystatus.firebasestorage.app",
            messagingSenderId: "666672171664",
            appId: "1:666672171664:web:2b23bab0c3ff77943e6615",
            measurementId: "G-Q1TBBHQ90Z"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);
        const matchesRef = ref(db, 'matches');
        const activeGameRef = ref(db, 'active_game');

        // --- 1. æœ¬å½“ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ (æ˜¨æ—¥ã®æ™‚ç‚¹ã¾ã§ã®è¨˜éŒ²) ---
        const LEGACY_STATS = {
            "å‰è°·æ‚ ": { games: 66, wins: 25, throws: 660, misses: 218, points: 2640 },
            "çŸ³äº•å±±æ‹“ç™»": { games: 61, wins: 26, throws: 610, misses: 140, points: 2440 },
            "æ£®å²¡å‡œå¤ªéƒ": { games: 35, wins: 14, throws: 350, misses: 98, points: 1400 }
        };

        // --- 2. ä»Šæ—¥ã®4è©¦åˆ (ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ã«å€‹åˆ¥ã«å®šç¾©) ---
        // â€»ã“ã‚ŒãŒã€Œæ–°è¦ãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦èªè­˜ã•ã‚Œã€ã‚°ãƒ©ãƒ•ã‚„ãƒ©ã‚¹å›é¿ç‡ã«åæ˜ ã•ã‚Œã¾ã™
        const TODAY_MATCHES = [
            { ranking: ["çŸ³äº•å±±æ‹“ç™»", "æ£®å²¡å‡œå¤ªéƒ", "å‰è°·æ‚ "] },
            { ranking: ["æ£®å²¡å‡œå¤ªéƒ", "å‰è°·æ‚ ", "çŸ³äº•å±±æ‹“ç™»"] },
            { ranking: ["æ£®å²¡å‡œå¤ªéƒ", "çŸ³äº•å±±æ‹“ç™»", "å‰è°·æ‚ "] },
            { ranking: ["å‰è°·æ‚ ", "æ£®å²¡å‡œå¤ªéƒ", "çŸ³äº•å±±æ‹“ç™»"] }
        ];

        // State
        const STATUS = { PLAYING: 'playing', CLEARED: 'cleared', ELIMINATED: 'eliminated' };
        let players = [], currentIndex = 0, clearOrder = [], eliminatedStack = [], currentMode = 'snipe';
        let undoStack = [];
        let globalMatchHistory = [];
        let isGameActive = false;

        // Sync Logic
        onValue(matchesRef, (snapshot) => {
            const data = snapshot.val();
            globalMatchHistory = data ? Object.values(data) : [];
            if (document.getElementById('records-container')) renderRecordsContent();
        });

        onValue(activeGameRef, (snapshot) => {
            const data = snapshot.val();
            const homeBtn = document.getElementById('btn-new-game');
            if (data) {
                isGameActive = true;
                players = data.players || [];
                currentIndex = data.currentIndex || 0;
                clearOrder = data.clearOrder || [];
                eliminatedStack = data.eliminatedStack || [];
                currentMode = data.currentMode || 'snipe';
                undoStack = data.undoStack ? JSON.parse(data.undoStack) : [];
                if (homeBtn) {
                    homeBtn.innerHTML = '<span class="mr-3">âš ï¸</span> é–‹å‚¬ä¸­ã®ã‚²ãƒ¼ãƒ ã«å‚åŠ ';
                    homeBtn.className = "w-full py-5 bg-orange-600 text-white rounded-2xl font-bold text-2xl shadow-lg hover:bg-orange-500 transition transform hover:-translate-y-1 flex items-center justify-center animate-pulse";
                    homeBtn.onclick = () => window.router('game');
                }
                if (document.getElementById('view-game-container')) renderGameContent(); 
            } else {
                isGameActive = false;
                if (homeBtn) {
                    homeBtn.innerHTML = '<span class="mr-3">ğŸ”¥</span> æ–°ã—ã„è©¦åˆ';
                    homeBtn.className = "w-full py-5 bg-yellow-600 text-white rounded-2xl font-bold text-2xl shadow-lg hover:bg-yellow-500 transition transform hover:-translate-y-1 flex items-center justify-center";
                    homeBtn.onclick = () => window.router('setup');
                }
            }
        });

        const app = document.getElementById('app-container');
        window.router = function(page) {
            app.innerHTML = ''; 
            if (page === 'home') renderHome();
            else if (page === 'setup') renderSetup();
            else if (page === 'game') renderGame();
            else if (page === 'result') renderResult();
            else if (page === 'records') renderRecords();
        }
        window.router('home');

        // HOME
        function renderHome() {
            app.innerHTML = `
                <div class="flex-grow flex flex-col justify-center items-center p-6 bg-gray-900">
                    <div class="mb-10 text-center"><h1 class="text-6xl font-black text-yellow-500 mb-2 tracking-tighter drop-shadow-lg leading-none">MÃ¶lkky<br>Stats</h1><p class="text-gray-400 text-sm font-bold tracking-widest uppercase">Official Log App</p></div>
                    <div class="w-full space-y-4">
                        <button id="btn-new-game" onclick="window.router('setup')" class="w-full py-5 bg-yellow-600 text-white rounded-2xl font-bold text-2xl shadow-lg hover:bg-yellow-500 transition transform hover:-translate-y-1 flex items-center justify-center"><span class="mr-3">ğŸ”¥</span> æ–°ã—ã„è©¦åˆ</button>
                        <button onclick="window.router('records')" class="w-full py-5 bg-gray-800 text-gray-300 rounded-2xl font-bold text-xl shadow-lg hover:bg-gray-700 transition transform hover:-translate-y-1 flex items-center justify-center border border-gray-700"><span class="mr-3">ğŸ“Š</span> è¨˜éŒ²ãƒ»åˆ†æ</button>
                    </div>
                    <button onclick="window.resetAllData()" class="mt-8 text-xs text-red-500 underline font-bold">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå» (ç®¡ç†è€…ç”¨)</button>
                </div>
            `;
            if(isGameActive) {
                const b = document.getElementById('btn-new-game');
                if(b) { b.innerHTML = '<span class="mr-3">âš ï¸</span> é–‹å‚¬ä¸­ã®ã‚²ãƒ¼ãƒ ã«å‚åŠ '; b.className = "w-full py-5 bg-orange-600 text-white rounded-2xl font-bold text-2xl shadow-lg hover:bg-orange-500 transition transform hover:-translate-y-1 flex items-center justify-center animate-pulse"; b.onclick = () => window.router('game'); }
            }
        }
        window.resetAllData = function() { if(confirm("ã€è­¦å‘Šã€‘å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { remove(matchesRef); remove(activeGameRef); alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"); } }

        // SETUP
        function renderSetup() {
            app.innerHTML = `
                <div class="p-4 bg-gray-900 h-full flex flex-col">
                    <div class="pt-12 pb-4 text-center"><h2 class="text-xl font-bold text-white tracking-widest border-b-2 border-yellow-600 inline-block pb-1">PLAYER ENTRY</h2></div>
                    <p class="text-xs text-center text-gray-500 mb-2">â‰¡ ã‚’é•·æŠ¼ã—ã—ã¦é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆ</p>
                    <div class="flex-grow overflow-y-auto space-y-3 px-2 custom-scrollbar" id="player-input-list"></div>
                    <div class="mt-4 space-y-3">
                        <button onclick="window.addPlayerInput()" class="w-full py-3 bg-gray-800 text-gray-400 rounded-xl text-sm border-dashed border-2 border-gray-700 font-bold hover:bg-gray-750">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
                        <button onclick="window.startGame()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-blue-500 transition">GAME START</button>
                    </div>
                </div>
            `;
            const list = document.getElementById('player-input-list'); list.innerHTML = '';
            const initialNames = players.length > 0 ? players.map(p=>p.name) : ['å‰è°·æ‚ ', 'çŸ³äº•å±±æ‹“ç™»', 'æ£®å²¡å‡œå¤ªéƒ'];
            initialNames.forEach(n => createInputRow(list, n));
            new Sortable(list, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost' });
        }
        function createInputRow(container, nameValue) {
            const div = document.createElement('div');
            div.className = "flex items-center space-x-2 mb-2 bg-gray-800 p-2 rounded-xl border border-gray-700";
            div.innerHTML = `<div class="drag-handle p-3 cursor-grab text-gray-500 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></div><input type="text" value="${nameValue}" class="flex-1 bg-transparent text-white font-bold p-2 outline-none" readonly onclick="this.removeAttribute('readonly');this.focus();" onblur="this.setAttribute('readonly','readonly')">`;
            container.appendChild(div);
        }
        window.addPlayerInput = function() { createInputRow(document.getElementById('player-input-list'), "Player " + (document.getElementById('player-input-list').children.length + 1)); }
        window.startGame = function() {
            const inputs = document.querySelectorAll('#player-input-list input');
            players = []; clearOrder = []; eliminatedStack = []; undoStack = [];
            inputs.forEach(i => { if(i.value.trim() !== "") players.push({ name: i.value, score: 0, miss: 0, status: STATUS.PLAYING, stats: { snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0 } }); });
            if(players.length < 1) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“");
            currentIndex = 0; currentMode = 'snipe';
            saveActiveGame(); window.router('game');
        }

        // GAME
        function renderGame() { app.innerHTML = `<div id="view-game-container" class="flex flex-col h-full bg-gray-900"></div>`; renderGameContent(); }
        function renderGameContent() {
            const container = document.getElementById('view-game-container'); if(!container) return;
            container.innerHTML = `
                <div class="flex-grow overflow-y-auto custom-scrollbar pt-14 px-1 pb-2 bg-gray-800">
                    <table class="w-full text-left border-collapse"><thead class="text-xs text-gray-500 sticky top-0 bg-gray-800 z-10 shadow-sm"><tr><th class="pb-2 pl-3 pt-2">NAME</th><th class="pb-2 text-center pt-2">MISS</th><th class="pb-2 text-right pr-4 pt-2">SCORE</th></tr></thead>
                    <tbody id="scoreboard-body" class="text-sm font-bold">${players.map((p, i) => {
                        let st="text-gray-300 border-b border-gray-700", ic="";
                        if(p.status===STATUS.ELIMINATED) {st="text-gray-600 bg-gray-800/50"; ic="ğŸ’€";} else if(p.status===STATUS.CLEARED) {st="text-green-400 bg-green-900/20"; ic="ğŸ‘‘";} else if(i===currentIndex) st="text-white bg-yellow-900/20 border-l-4 border-yellow-500";
                        let mh=""; for(let m=0;m<3;m++) mh+=(m<p.miss)?"âŒ":"â—";
                        return `<tr class="${st}"><td class="py-3 pl-3 flex items-center"><span class="w-5 text-center mr-1">${ic}</span>${p.name}</td><td class="text-center text-[10px] text-gray-500">${mh}</td><td class="text-right pr-4 font-mono text-xl">${p.status===STATUS.ELIMINATED?'-':p.score}</td></tr>`;
                    }).join('')}</tbody></table>
                </div>
                <div class="flex-none bg-gray-900 pb-8 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.5)] z-20 relative px-3">
                    <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 mb-2">
                        <div class="overflow-hidden"><span class="text-[10px] text-green-400 font-bold tracking-widest block">THROWING NEXT</span><span id="current-player-name" class="text-xl font-black text-white tracking-tight truncate block">${players[currentIndex].name}</span></div>
                        <div class="text-right flex-none pl-2"><span class="text-[10px] text-gray-500 font-bold tracking-widest block">TARGET</span><span class="text-3xl font-black text-yellow-400 leading-none">50</span></div>
                    </div>
                    <div class="flex justify-center mb-4"><div class="bg-gray-800 p-1 rounded-xl flex w-full max-w-xs border border-gray-700">
                        <button onclick="window.switchMode('snipe')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${currentMode==='snipe' ? 'bg-yellow-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-700'}">ğŸ¯ Snipe</button>
                        <button onclick="window.switchMode('break')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${currentMode==='break' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-700'}">ğŸ’¥ Break</button>
                    </div></div>
                    <div id="pin-container" class="${currentMode==='snipe' ? 'mode-snipe' : 'mode-break'} flex flex-col items-center">
                        <div class="pin-row"><button class="score-btn" onclick="window.inputScore(7)">7</button><button class="score-btn" onclick="window.inputScore(9)">9</button><button class="score-btn" onclick="window.inputScore(8)">8</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="window.inputScore(5)">5</button><button class="score-btn" onclick="window.inputScore(11)">11</button><button class="score-btn" onclick="window.inputScore(12)">12</button><button class="score-btn" onclick="window.inputScore(6)">6</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="window.inputScore(3)">3</button><button class="score-btn" onclick="window.inputScore(10)">10</button><button class="score-btn" onclick="window.inputScore(4)">4</button></div>
                        <div class="pin-row"><button class="score-btn" onclick="window.inputScore(1)">1</button><button class="score-btn" onclick="window.inputScore(2)">2</button></div>
                    </div>
                    <div class="mt-2 px-4 flex gap-3">
                        <button onclick="window.inputScore(0)" class="flex-1 py-3 btn-miss text-white font-black rounded-xl text-lg tracking-wider active:bg-red-700 transition">MISS (0)</button>
                        <button onclick="window.undoLastThrow()" class="w-24 btn-undo rounded-xl text-lg font-bold flex items-center justify-center active:bg-gray-700 transition text-white"><span class="text-sm">â—‚ 1æŠ•æˆ»ã‚‹</span></button>
                    </div>
                </div>`;
        }
        window.switchMode = function(mode) { currentMode = mode; saveActiveGame(); }
        function saveActiveGame() { set(activeGameRef, { players, currentIndex, clearOrder, eliminatedStack, currentMode, undoStack: JSON.stringify(undoStack) }); }
        
        window.inputScore = function(pnt) {
            undoStack.push(JSON.parse(JSON.stringify({ players, currentIndex, clearOrder, eliminatedStack, currentMode }))); // Save Undo
            const p = players[currentIndex];
            p.stats.throws++; p.stats.totalPoints += pnt;
            if(pnt===0) { p.stats.misses++; } else { if(currentMode==='snipe') p.stats.snipes++; else p.stats.breaks++; }
            if(pnt===0) { p.miss++; if(p.miss>=3) { p.status=STATUS.ELIMINATED; eliminatedStack.push(p); alert(`${p.name} å¤±æ ¼ï¼`); } } 
            else { p.miss=0; let next=p.score+pnt; if(next===50) { p.score=50; p.status=STATUS.CLEARED; clearOrder.push(p); alert(`${p.name} ã‚¯ãƒªã‚¢ï¼`); } else if(next>50) { p.score=25; alert("ã‚ªãƒ¼ãƒãƒ¼ï¼25ç‚¹ã«æˆ»ã‚Šã¾ã™"); } else p.score=next; }
            
            const active = players.filter(pl=>pl.status===STATUS.PLAYING);
            if(active.length<=1) { saveActiveGame(); setTimeout(() => finishGameLogic(), 300); } 
            else { 
                let loop=0; do { currentIndex=(currentIndex+1)%players.length; loop++; if(loop>players.length)break; } while(players[currentIndex].status!==STATUS.PLAYING);
                saveActiveGame(); 
            }
        }
        window.undoLastThrow = function() {
            if (undoStack.length === 0) return alert("ã“ã‚Œä»¥ä¸Šæˆ»ã‚Œã¾ã›ã‚“");
            const prev = undoStack.pop();
            players = prev.players; currentIndex = prev.currentIndex; clearOrder = prev.clearOrder; eliminatedStack = prev.eliminatedStack; currentMode = prev.currentMode;
            saveActiveGame();
        }
        function finishGameLogic() {
            const surv = players.filter(p=>p.status===STATUS.PLAYING);
            const rankObj = [...clearOrder, ...surv, ...eliminatedStack.reverse()];
            const mData = { date: new Date().toISOString(), ranking: rankObj.map(p=>p.name), details: {} };
            rankObj.forEach(p=>mData.details[p.name]=p.stats);
            push(matchesRef, mData); remove(activeGameRef); window.router('result');
        }
        function renderResult() {
            const surv = players.filter(p=>p.status===STATUS.PLAYING);
            const rankObj = [...clearOrder, ...surv, ...eliminatedStack.reverse()];
            app.innerHTML = `<div class="view-section active-view justify-center items-center p-6 text-center bg-gray-900"><h2 class="text-4xl text-yellow-400 font-black mb-6 tracking-tighter drop-shadow-md">GAME SET!</h2><div class="w-full bg-gray-800 rounded-2xl p-4 mb-6 text-left space-y-2 shadow-lg border border-gray-700 overflow-y-auto max-h-[50vh]" id="result-list"></div><div class="w-full space-y-3"><button onclick="window.restartGame()" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-500 transition shadow-lg flex items-center justify-center"><span class="mr-2">ğŸ”„</span> ã‚‚ã†ä¸€å› (Rematch)</button><button onclick="window.router('home')" class="w-full py-4 bg-gray-700 text-white rounded-xl font-bold hover:bg-gray-600 transition border border-gray-600">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button></div></div>`;
            const l = document.getElementById('result-list');
            rankObj.forEach((p,i)=>{ let c=i===0?"text-yellow-400":i===1?"text-gray-300":"text-orange-400"; l.innerHTML+=`<div class="flex justify-between border-b border-gray-700 py-3"><div class="${c} font-bold text-xl w-12">${i+1}th</div><div class="text-white font-bold">${p.name}</div><div class="text-gray-400 font-mono">${p.score}pt</div></div>`; });
        }
        window.restartGame = function() { currentIndex=0; clearOrder=[]; eliminatedStack=[]; undoStack=[]; players.forEach(p=>{ p.score=0; p.miss=0; p.status=STATUS.PLAYING; p.stats={ snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0 }; }); saveActiveGame(); window.router('game'); }

        // RECORDS
        function renderRecords() {
            app.innerHTML = `<div class="bg-gray-900 pt-16 flex flex-col h-full"><div class="px-4 pb-4 bg-gray-900 border-b border-gray-800 z-10"><h2 class="text-2xl font-black text-white text-center mb-1">RECORDS</h2><p class="text-xs text-gray-500 text-center mb-4">æˆ¦ç¸¾ãƒªã‚¹ãƒˆ (å¹³å‡é †ä½é †)</p><div class="flex items-end px-2 pb-2 text-gray-400 border-b border-gray-700"><div class="w-10 text-center"><span class="block text-xs font-bold text-white leading-none">é †ä½</span><span class="block text-[8px] font-normal leading-none mt-1">RANK</span></div><div class="flex-1 pl-2"><span class="block text-xs font-bold text-white leading-none">åå‰</span><span class="block text-[8px] font-normal leading-none mt-1">NAME</span></div><div class="w-16 text-center"><span class="block text-xs font-bold text-white leading-none">å¹³å‡é †ä½</span><span class="block text-[8px] font-normal leading-none mt-1">AVG RANK</span></div><div class="w-12 text-center"><span class="block text-xs font-bold text-white leading-none">å¹³å‡ç‚¹</span><span class="block text-[8px] font-normal leading-none mt-1">AVG</span></div></div></div><div class="flex-grow overflow-y-auto custom-scrollbar px-4 pb-10" id="records-container"></div></div>`;
            renderRecordsContent();
        }
        function renderRecordsContent() {
            const con = document.getElementById('records-container'); if(!con) return; con.innerHTML = '';
            let pStats = {};

            // 1. ãƒ¬ã‚¬ã‚·ãƒ¼(ã€œæ˜¨æ—¥)
            for(const [name, d] of Object.entries(LEGACY_STATS)) {
                const nonWin = d.games - d.wins;
                pStats[name] = { rankSum: (d.wins*1)+(nonWin*2.5), wins: d.wins, totalGames: d.games, stats: { throws: d.throws, misses: d.misses, totalPoints: d.points, snipes:0, breaks:0, clutchHits:0, clutchMisses:0 }, newStats: { games:0, wins:0, lastPlaceCount:0, snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0 }, last10Stats: [] };
            }

            // 2. ä»Šæ—¥(æ‰‹å‹•4æˆ¦)ã‚’ã€Œæ–°è¦ã€ã¨ã—ã¦åŠ ç®—
            TODAY_MATCHES.forEach((m, idx) => {
                m.ranking.forEach((name, rIdx) => {
                    if(!pStats[name]) return;
                    let ps = pStats[name], ns = ps.newStats;
                    // å…¨ä½“
                    ps.rankSum += (rIdx+1); ps.totalGames++; if(rIdx===0) ps.wins++;
                    // æ–°è¦
                    ns.games++; if(rIdx===0) ns.wins++; if(rIdx===m.ranking.length-1) ns.lastPlaceCount++;
                    ps.last10Stats.push({ rank: rIdx+1 });
                });
            });

            // 3. Firebase(ä»Šå¾Œ)
            globalMatchHistory.forEach(m => {
                m.ranking.forEach((name, idx) => {
                    if(!pStats[name]) pStats[name] = { rankSum:0, wins:0, totalGames:0, stats:{throws:0, misses:0, totalPoints:0, snipes:0, breaks:0, clutchHits:0, clutchMisses:0}, newStats:{games:0, wins:0, lastPlaceCount:0, snipes:0, breaks:0, misses:0, clutchHits:0, clutchMisses:0, totalPoints:0, throws:0}, last10Stats:[] };
                    let ps = pStats[name], ns = ps.newStats;
                    ps.rankSum += (idx+1); ps.totalGames++; if(idx===0) ps.wins++;
                    if(m.details && m.details[name]) {
                        const d = m.details[name];
                        ps.stats.misses+=d.misses||0; ps.stats.totalPoints+=d.totalPoints||0; ps.stats.throws+=d.throws||0;
                        ns.games++; if(idx===0) ns.wins++; if(idx===m.ranking.length-1) ns.lastPlaceCount++;
                        ns.snipes+=d.snipes||0; ns.breaks+=d.breaks||0; ns.misses+=d.misses||0; ns.clutchHits+=d.clutchHits||0; ns.clutchMisses+=d.clutchMisses||0; ns.totalPoints+=d.totalPoints||0; ns.throws+=d.throws||0;
                        ps.last10Stats.push({ rank: idx+1 });
                    }
                });
            });

            let lb = Object.keys(pStats).map(n => { const d=pStats[n]; return { name:n, avgRank:d.totalGames>0?d.rankSum/d.totalGames:999, ppt:d.stats.throws>0?d.stats.totalPoints/d.stats.throws:0, data:d }; }).sort((a,b) => a.avgRank - b.avgRank);

            lb.forEach((p, i) => {
                let rc = i===0?"rank-1":i===1?"rank-2":i===2?"rank-3":"text-white";
                const row = document.createElement('div');
                row.className = "bg-gray-800 rounded-xl mb-3 overflow-hidden border border-gray-700";
                row.innerHTML = `
                    <div class="flex items-center p-4 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('detail-open')"><div class="w-10 text-center text-2xl font-black ${rc}">${i+1}</div><div class="flex-1 pl-2 font-bold text-lg text-white">${p.name}</div><div class="w-16 text-center font-mono font-bold text-yellow-400">${p.avgRank.toFixed(2)}</div><div class="w-12 text-center text-xs text-gray-500 font-mono">${p.ppt.toFixed(1)}</div></div>
                    <div class="player-detail px-4 bg-gray-900 border-t border-gray-800"><div class="py-4 space-y-6">
                        <div class="chart-container text-center"><h4 class="text-xs text-gray-400 mb-2 font-bold tracking-widest">PERFORMANCE RADAR (New Games)</h4>${genRadar(p.data)}</div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700"><h4 class="text-xs text-gray-400 mb-3 font-bold border-b border-gray-700 pb-2 tracking-widest">ä¸»è¦æŒ‡æ¨™</h4>${genLast10Stats(p.data)}</div>
                        <div class="chart-container"><h4 class="text-xs text-gray-400 mb-2 font-bold tracking-widest">RANKING HISTORY (New Games)</h4>${genLine(p.data.last10Stats.map(x=>x.rank))}</div>
                    </div></div>`;
                con.appendChild(row);
            });
            // ã‚¬ã‚¤ãƒ‰
            con.innerHTML += `<div class="mt-8 p-4 bg-gray-800/50 rounded-xl border border-gray-700 text-xs text-gray-400"><h3 class="font-bold text-white mb-3 text-sm border-b border-gray-600 pb-2">ğŸ“Š æŒ‡æ¨™ã‚¬ã‚¤ãƒ‰</h3><table class="w-full text-left border-collapse"><tbody class="divide-y divide-gray-700"><tr><th class="py-2 text-yellow-400 font-bold pr-2 whitespace-nowrap">å¹³å‡ç‚¹ (AVG)</th><td class="py-2">1æŠ•ã‚ãŸã‚Šã®å¹³å‡å¾—ç‚¹ (PPT)ã€‚<br>5.0ä»¥ä¸Šã§ä¸Šç´šè€…ã€‚</td></tr><tr><th class="py-2 text-white font-bold pr-2">å‹ç‡</th><td class="py-2">1ä½ã‚’ç²å¾—ã—ãŸç¢ºç‡ã€‚</td></tr><tr><th class="py-2 text-white font-bold pr-2">ãƒ©ã‚¹å›é¿</th><td class="py-2">æœ€ä¸‹ä½ã«ãªã‚‰ãªã‹ã£ãŸç¢ºç‡ã€‚<br><span class="text-gray-500">â€»æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ç®—å‡º</span></td></tr><tr><th class="py-2 text-white font-bold pr-2">ç‹™æ’ƒç‡</th><td class="py-2">1æœ¬å€’ã—(Snipe)ã§å¾—ç‚¹ã—ãŸå‰²åˆã€‚<br><span class="text-gray-500">â€»æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ç®—å‡º</span></td></tr></tbody></table></div>`;
        }

        function genRadar(d) {
            const s = d.newStats; const hasNew = s.games > 0;
            const tThrows = s.snipes+s.breaks+s.misses||1; const vThrows = s.snipes+s.breaks||1;
            const winRate = Math.round((d.wins/d.totalGames)*100);
            const acc = Math.round(((d.stats.throws - d.stats.misses) / d.stats.throws)*100);
            const snipe = hasNew ? Math.round((s.snipes/vThrows)*100) : 0;
            const clutch = (hasNew && (s.clutchHits+s.clutchMisses)>0) ? Math.round((s.clutchHits/(s.clutchHits+s.clutchMisses))*100) : 0;
            const power = hasNew ? Math.min(100, Math.round(((s.totalPoints/s.throws || 0)/7) * 100)) : 0;
            const avoidLast = hasNew ? Math.round(((s.games - s.lastPlaceCount) / s.games) * 100) : 0;
            const params = [{l:"å‹ç‡",v:winRate},{l:"å‘½ä¸­ç‡",v:acc},{l:"ç‹™æ’ƒç‡",v:snipe},{l:"å‹è² å¼·ã•",v:clutch},{l:"å¾—ç‚¹åŠ›",v:power},{l:"ãƒ©ã‚¹å›é¿",v:avoidLast}];
            let pts="", lines="", lbls=""; const cx=150, cy=150, r=90;
            for(let i=0;i<6;i++){ const a=(Math.PI*2*i/6)-(Math.PI/2); const v=params[i].v; pts+=`${cx+(r*(v/100))*Math.cos(a)},${cy+(r*(v/100))*Math.sin(a)} `; lines+=`<line x1="${cx}" y1="${cy}" x2="${cx+r*Math.cos(a)}" y2="${cy+r*Math.sin(a)}" stroke="#374151"/>`; const lx=cx+(r+35)*Math.cos(a), ly=cy+(r+35)*Math.sin(a); lbls+=`<text x="${lx}" y="${ly}" font-size="10" fill="#fff" text-anchor="middle">${params[i].l}\n${v}%</text>`; }
            return `<svg viewBox="-20 -20 340 340" class="w-full"><circle cx="150" cy="150" r="90" fill="none" stroke="#374151"/><circle cx="150" cy="150" r="45" fill="none" stroke="#374151" stroke-dasharray="2,2"/>${lines}<polygon points="${pts}" fill="rgba(250,204,21,0.4)" stroke="#facc15" stroke-width="2"/>${lbls}</svg>`;
        }
        function genLast10Stats(d) {
            const winRate = Math.round((d.wins/d.totalGames)*100) + "%"; const avgRank = (d.rankSum / d.totalGames).toFixed(2); const avgScore = d.stats.throws > 0 ? (d.stats.totalPoints/d.stats.throws).toFixed(1) : "-"; const acc = Math.round(((d.stats.throws - d.stats.misses) / d.stats.throws)*100) + "%";
            const ns = d.newStats; const hasNew = ns.games > 0;
            const snipeRate = hasNew ? Math.round((ns.snipes / (ns.snipes+ns.breaks||1))*100) + "%" : "-";
            const lastAvoid = hasNew ? Math.round(((ns.games - ns.lastPlaceCount) / ns.games)*100) + "%" : "-";
            return `<div class="grid grid-cols-3 gap-2 text-center"><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-yellow-400">${winRate}</span><span class="stat-label">å‹ç‡</span></div><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-white">${avgRank}</span><span class="stat-label">å¹³å‡é †ä½</span></div><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-white">${avgScore}</span><span class="stat-label">å¹³å‡å¾—ç‚¹</span></div><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-blue-300">${acc}</span><span class="stat-label">å‘½ä¸­ç‡</span></div><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-green-400">${snipeRate}</span><span class="stat-label">ç‹™æ’ƒç‡(æ–°)</span></div><div class="bg-gray-700 p-2 rounded"><span class="stat-val text-pink-400">${lastAvoid}</span><span class="stat-label">ãƒ©ã‚¹å›é¿(æ–°)</span></div></div>`;
        }
        function genLine(ranks) {
            if (!ranks || ranks.length === 0) return '<div class="text-xs text-gray-600 text-center py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            const r = ranks.slice(-10); if(r.length===1) return `<svg viewBox="0 0 280 90" class="w-full h-24 bg-gray-800 rounded border border-gray-700"><circle cx="140" cy="${10+(r[0]-1)*20}" r="4" fill="#60a5fa"/><text x="140" y="${10+(r[0]-1)*20-10}" fill="#60a5fa" font-size="12" text-anchor="middle">${r[0]}ä½</text></svg>`;
            const w=280, h=80, step=w/(r.length-1); let p=""; r.forEach((rk,i)=>{ p+=`${i*step},${10+(rk-1)*20} `; });
            return `<svg viewBox="0 0 280 90" class="w-full h-24 bg-gray-800 rounded border border-gray-700"><polyline points="${p}" fill="none" stroke="#60a5fa" stroke-width="2"/>${r.map((rk,i)=>`<circle cx="${i*step}" cy="${10+(rk-1)*20}" r="3" fill="#60a5fa"/>`).join('')}</svg>`;
        }
    </script>
</body>
</html>
